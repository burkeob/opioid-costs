group_by(state.fips.character) %>%
summarise(opioid_deaths = 100 * sum(est_opioid_deaths, na.rm = T)/sum(total_population, na.rm = T), # percent opioid deaths
modeled_pct = sum(total_population * modeled, na.rm = T)/sum(total_population, na.rm = T)) # imputed percent scaled by population
projection_summary2 <- proj_hospital_costs %>% left_join(demographics) %>%
select(total_costs, est_total_hosp_costs, total_population, state.fips.character) %>%
mutate(modeled = ifelse(is.na(total_costs), 1, 0)) %>%
group_by(state.fips.character) %>%
summarise(per_capita_costs = sum(est_total_hosp_costs, na.rm = T)/sum(total_population, na.rm = T),
modeled_pct = sum(total_population * modeled, na.rm = T)/sum(total_population, na.rm = T))
```
### Creating County-Level Estimates
In this section, we allocate the mortality, health care, productivity, and criminal justice costs associated with the opioid crisis across states and counties.
#### Mortality Costs
**State Estimates**
We distribute CEA's estimates for total opioid-related mortality costs at the state level proportionally to each state's number of opioid-related deaths:
Let $m_s$ represent a state "$s$"'s opioid-related mortality costs.
<center>
$m_s = w_s *$ overall mortality costs (CEA),
</center>
where $w_s$ is that state's total share of all opioid-related costs. We calculate $w_s$ as follows:
$$
w_s = \frac{d_s}{\sum_s{d_s}}
$$
$d_s$ represents the number of opioid-related deaths in state $s$.
**County Estimates**
For county-level mortality costs, we allocate our state-level estimates proportionally to the number of [opioid-related deaths](#deathmodel) in each state's respective counties.
Let $m_{s,c}$ represent county $c$ in state $s's$ total opioid mortality costs.
$$
m_{s,c} = w_{s,c} \cdot m_s
$$
$w_{s,c}$ represents a county's share of opioid deaths:
$$
w_{s,c} = \frac{d_{s,c}}{\sum_{c\in s}{d_{s,c}}}
$$
where $d_{s,c}$ is the estimated number of deaths in county $c$ in state $s$.
#### Health Care Costs
**State Estimates**
We allocate health care costs associated with the opioid crisis proportionally to states' opioid-related hospitalization costs. As our data only contain hospitalization costs for opioid-related conditions in 32 states, we use [predicted estimates](#hospmodel) for the remaining states and the District of Columbia.
Let $h_s$ represent a state "$s$"'s opioid-related health care costs.
<center>
$h_s = x_s *$ Overall Healthcare Costs (CEA),
</center>
where $x_s$ is that state's total share of all opioid-related costs. We calculate $x_s$ as follows:
$$
x_s = \frac{h'_s}{\sum_s{h'_s}}
$$
where $h'_s$ is state $s$'s actual or predicted total opioid-related hospitalization costs.
**County Estimates**
We allocate our state-level estimates to their respective counties proportionally to their actual or predicted opioid-related hospitalization costs:
Let $h_{s,c}$ represent county $c$ in state $s's$ total estimated opioid-related healthcare costs.
$$
h_{s,c} = x_{s,c} \cdot h_s
$$
$x_{s,c}$ represents a county's share of total opioid-related hospitalization costs:
$$
x_{s,c} = \frac{h'_{s,c}}{\sum_{c\in s}{h'_{s,c}}}
$$
where $h'_{s,c}$ is county $c$'s estimated opioid-related hospitalization costs.
#### Productivity Costs
**County Estimates**
We allocate county-level opioid-related productivity costs proportionately with each county's median household income, working age population, proportion of people who use pain relievers for nonmedical use, and the overall loss of productivity due to opioid abuse of dependence.
Let $p_{s,c}$ be a county $c$ in state $s$'s productivity costs associated with the opioid crisis:
<center>
$p_{s,c} = y_{s,c}  *$ Overall Productivity Costs
</center>
where $y_{s,c}$ is a county-level weight defined as follows:
$$
y_{s,c} = \frac{i_{s,c} \cdot n_{s,c} \cdot u_{s,c} \cdot 0.175}{\sum_{s,c}{i_{s,c} \cdot n_{s,c} \cdot u_{s,c} \cdot 0.175}}
$$
$i_{s,c}$ represents a county's median income, $n_{s,c}$ represents that county's working population, $u_{s,c}$ is the county's proportion of people who use pain relievers for nonmedical use.
**State Estimates**
To calculate state-level productivity costs $p_s$, we aggregate the county-level costs:
$$
p_s = \sum_{c\in s}p_{s,c}
$$
#### Criminal Justice Costs
**County Estimates**
We estimate county-level criminal justice costs associated with the opioid crisis by allocating state-level criminal justice costs proportionally to the number of individuals in a county using pain relievers for nonmedical use.
Let $c_{s,c}$ be a county $c$ in state $s$'s criminal justice costs:
<center>
$c_{s,c} = z_{s,c} *$ Overall Criminal Justice Costs
</center>
where $z_{s,c}$ is a county-level weight defined as follows:
$$
z_{s,c} = \frac{c'_s \cdot n_{s,c} \cdot u_{s,c}}{\sum_{s,c}{c'_s} \cdot n_{s,c} \cdot u_{s,c}}
$$
$c'_s$ is a state's per-capita criminal justice expenditures. $n_{s,c}$ is the overall county population. $u_{s,c}$ is the proportion of people in county $c$ who use pain relievers for nonmedical use.
**State Estimates**
We sum our county-level criminal justice costs to the state-level to derive total state opioid-related criminal justice costs, $c_s$:
$$
c_s = \sum_{c\in s}{c_{s,c}}
$$
```{r, build.model}
# opioid cost parameters, from the updated CEA estimates
fatal_costs <- 712.9439
total_nonfatal_costs <- 66.16359032
nonfatal_health_costs <- total_nonfatal_costs * 0.5068966
total_criminal_justice_costs <- total_nonfatal_costs * 0.1344828
total_productivity_costs <- total_nonfatal_costs * 0.3586207
d <- county.regions %>% tbl_df %>%
left_join(proj_opioid_deaths %>% select(region, est_opioid_deaths)) %>%
left_join(proj_hospital_costs %>% select(region, est_total_hosp_costs)) %>%
left_join(nonmedical_use) %>%
left_join(medical_cost_index) %>%
left_join(criminal_costs) %>%
left_join(demographics)
# allocate opioid costs
d <- d %>% filter(!is.na(total_population), !is.na(med_income)) %>%
mutate(death_wt = est_opioid_deaths/sum(est_opioid_deaths, na.rm = T), # county death cost weight
death_cost = death_wt * fatal_costs * 10^9,
death_cost_pc = death_cost/total_population) %>%
mutate(health_wt = est_total_hosp_costs/sum(est_total_hosp_costs, na.rm = T), # county health care cost weight
health_cost = health_wt * nonfatal_health_costs * 10^9,
health_cost_pc = health_cost/total_population) %>%
mutate(criminal_wt = (nonmedical_use_pct * total_population * criminal_cost_per_capita)/sum(nonmedical_use_pct * total_population * criminal_cost_per_capita, na.rm = T), # criminal justice cost weight
criminal_cost = criminal_wt * total_criminal_justice_costs * 10^9,
criminal_cost_pc = criminal_cost/total_population) %>%
mutate(productivity_wt = (med_income * 0.175 * nonmedical_use_pct * working_population)/sum(med_income * 0.175 * nonmedical_use_pct * working_population, na.rm = T), # productivity cost weight
productivity_cost = productivity_wt * total_productivity_costs * 10^9,
productivity_cost_pc = productivity_cost/total_population)
# here we map opioid costs by county
# we exclude Alaska and Hawaii
o <- d %>%
filter(total_population > 2500, !(state.name %in% c("alaska", "hawaii"))) %>%
select(region, county.name, state.name, death_cost, death_cost_pc,
health_cost, health_cost_pc, criminal_cost, criminal_cost_pc,
productivity_cost, productivity_cost_pc, total_population) %>%
mutate(nonfatal_cost = (criminal_cost + health_cost + productivity_cost),
total_cost = (criminal_cost + health_cost + productivity_cost + death_cost),
per_capita_nf_cost = (criminal_cost + health_cost + productivity_cost)/total_population,
per_capita_total_cost = (criminal_cost + health_cost + productivity_cost + death_cost)/total_population)
write_csv(o, "../out/county_data_2017.csv")
map1 <- o %>% select(region, per_capita_nf_cost) %>%
mutate(value = per_capita_nf_cost) %>%
select(region, value)
c$title = "Non-Fatal Opioid Costs Per Capita by County in 2015"
c$set_num_colors(5)
c$ggplot_scale = scale_fill_manual(values = brewer.pal(5, "Oranges"),
name = "Per Capita Cost",
labels = c(str_c("$", q[1] %>% round, " to $", q[2] %>% round),
str_c("$", q[2] %>% round, " to $", q[3] %>% round),
str_c("$", q[3] %>% round, " to $", q[4] %>% round),
str_c("$", q[4] %>% round, " to $", q[5] %>% round),
str_c("$", q[5] %>% round, " to $", q[6] %>% round)),
na.value = "black",
drop = F)
# create county map
c = CountyChoropleth$new(map1)
# create county map
c = CountyChoropleth$new(map1)
c$title = "Non-Fatal Opioid Costs Per Capita by County in 2015"
c$set_num_colors(5)
c$set_num_colors(5)
c$set_zoom(state.regions$region[-c(1, 12)])
c$render() +
theme(text=element_text(size=14,  family="Times")) +
theme(plot.title = element_text(hjust = 0.5),
plot.caption = element_text(size = 8),
legend.title = element_text(size = 12),
legend.text = element_text(size = 10))
c$render() +
theme(text=element_text(size=14,  family="Times")) +
theme(plot.title = element_text(hjust = 0.5),
plot.caption = element_text(size = 8),
legend.title = element_text(size = 12),
legend.text = element_text(size = 10))
map2 <- o %>% select(region, per_capita_total_cost) %>%
mutate(value = per_capita_total_cost) %>%
select(region, value)
q <- c(160, 824, 1153, 1585, 2232, 8734)
c = CountyChoropleth$new(map2)
c = CountyChoropleth$new(map2)
c$title = "Total Opioid Costs Per Capita by County in 2015"
c$set_num_colors(5)
c$set_zoom(state.regions$region[-c(1, 12)])
c$ggplot_scale = scale_fill_manual(values = brewer.pal(5, "Oranges"),
name = "Per Capita Cost",
na.value = "black",
labels = c(str_c("$", q[1] %>% round, " to $", q[2] %>% round),
str_c("$", q[2] %>% round, " to $", q[3] %>% round),
str_c("$", q[3] %>% round, " to $", q[4] %>% round),
str_c("$", q[4] %>% round, " to $", q[5] %>% round),
str_c("$", q[5] %>% round, " to $", q[6] %>% round)),
drop = F)
c$render() +
theme(text=element_text(size=14,  family="Times")) +
theme(plot.title = element_text(hjust = 0.5),
plot.caption = element_text(size = 8),
legend.title = element_text(size = 12),
legend.text = element_text(size = 10))
o2 <- d %>% group_by(state.name) %>%
summarise(criminal_cost = sum(criminal_cost),
health_cost = sum(health_cost),
productivity_cost = sum(productivity_cost),
death_cost = sum(death_cost),
total_nonfatal_cost = sum(criminal_cost + health_cost + productivity_cost),
total_cost = sum(criminal_cost + health_cost + productivity_cost + death_cost),
total_population = sum(total_population),
criminal_cost_pc = sum(criminal_cost)/sum(total_population),
health_cost_pc = sum(health_cost)/sum(total_population),
productivity_cost_pc = sum(productivity_cost)/sum(total_population),
death_cost_pc = sum(death_cost)/sum(total_population)) %>%
ungroup %>%
mutate(per_capita_nf_cost = (criminal_cost + health_cost + productivity_cost)/total_population,
per_capita_total_cost = (criminal_cost + health_cost + productivity_cost + death_cost)/total_population,
region = state.name)
write_csv(o2, "../out/state_data.csv")
map3 <- o2 %>% select(region, per_capita_nf_cost) %>%
mutate(value = per_capita_nf_cost) %>%
select(region, value)
q <- c(118, 160, 195, 226, 289, 493)
c = StateChoropleth$new(map3)
c$title = "Non-Fatal Opioid Costs Per Capita by State in 2015"
c$set_num_colors(5)
c$set_zoom(state.regions$region[-c(1, 12)])
c$show_labels = FALSE
c$ggplot_scale = scale_fill_manual(values = brewer.pal(5, "Oranges"),
name = "Per Capita Cost",
na.value = "black",
labels = c(str_c("$", q[1] %>% round, " to $", q[2] %>% round),
str_c("$", q[2] %>% round, " to $", q[3] %>% round),
str_c("$", q[3] %>% round, " to $", q[4] %>% round),
str_c("$", q[4] %>% round, " to $", q[5] %>% round),
str_c("$", q[5] %>% round, " to $", q[6] %>% round)),
drop = F)
c$render() +
theme(text=element_text(size=14,  family="Times")) +
theme(plot.title = element_text(hjust = 0.5),
plot.caption = element_text(size = 8),
legend.title = element_text(size = 12),
legend.text = element_text(size = 10))
ggplotly(c)
map4 <- o2 %>% select(region, per_capita_total_cost) %>%
mutate(value = per_capita_total_cost) %>%
select(region, value)
q <- c(394, 907, 1385, 1827, 2530, 4378)
c = StateChoropleth$new(map4)
c$title = "Total Opioid Costs Per Capita by State in 2015"
c$set_num_colors(5)
c$set_zoom(state.regions$region[-c(1, 12)])
c$show_labels = FALSE
c$ggplot_scale = scale_fill_manual(values = brewer.pal(5, "Oranges"),
name = "Per Capita Cost",
labels = c(str_c("$", q[1] %>% round, " to $", q[2] %>% round),
str_c("$", q[2] %>% round, " to $", q[3] %>% round),
str_c("$", q[3] %>% round, " to $", q[4] %>% round),
str_c("$", q[4] %>% round, " to $", q[5] %>% round),
str_c("$", q[5] %>% round, " to $", q[6] %>% round)),
na.value = "black",
drop = F)
library(tidyverse)
county_2015 <- read_csv("../out/county_data_2015.csv")
state_2015 <- read_csv("../out/state_data_2015.csv")
county_2017 <- read_csv("../out/county_data_2017.csv")
state_2017 <- read_csv("../out/state_data_2015.csv")
comp <- county_2015 %>%
left_join(state_2015)
comp <- county_2015 %>%
left_join(state_2015, by = region)
comp <- county_2015 %>%
left_join(county_2017, by = "region")
View(comp)
View(county_2015)
# x is 2015, y is 2017
comp <- county_2015 %>%
left_join(county_2017, by = "region")
# x is 2015, y is 2017
comp <- county_2015 %>%
left_join(county_2017, by = "region") %>%
mutate(diff_cost = death_cost.y - death_cost.x)
hist(comp$diff_cost)
data(county)
data(counties)
data(county.regions)
View(county.regions)
# x is 2015, y is 2017
comp <- county_2015 %>%
left_join(county_2017, by = "region") %>%
mutate(diff_cost = death_cost.y - death_cost.x) %>%
left_join(county.regions, by = "region")
View(comp)
# x is 2015, y is 2017
comp <- county_2015 %>%
left_join(county_2017, by = "region") %>%
mutate(death_cost_diff = death_cost.y - death_cost.x) %>%
left_join(county.regions, by = "region")
hist(comp$death_cost_diff)
# x is 2015, y is 2017
comp <- county_2015 %>%
left_join(county_2017, by = "region") %>%
mutate(death_cost_diff = death_cost.y - death_cost.x) %>%
mutate(death_cost_pc_diff = death_cost_pc.y - death_cost_pc.x) %>%
left_join(county.regions, by = "region")
hist(comp$death_cost_pc_diff)
View(d)
# x is 2015, y is 2017
comp <- county_2015 %>%
left_join(county_2017, by = "region") %>%
mutate(death_cost_diff = (death_cost.y - death_cost.x) / death_cost.x) %>%
mutate(death_cost_pc_diff = (death_cost_pc.y - death_cost_pc.x) / death_cost_pc.x) %>%
left_join(county.regions, by = "region")
hist(comp$death_cost_pc_diff)
hist(comp$death_cost_diff)
hist(comp$death_cost_pc_diff)
# x is 2015, y is 2017
comp <- county_2015 %>%
left_join(county_2017, by = "region") %>%
mutate(death_cost_diff = (death_cost.y - death_cost.x) / death_cost.x) %>%
mutate(death_cost_pc_diff = (death_cost_pc.y - death_cost_pc.x) / death_cost_pc.x) %>%
mutate(death_cost_diff = (total_cost.y - total_cost.x) / total_cost.x) %>%
mutate(death_cost_pc_diff = (total_cost_pc.y - total_cost_pc.x) / total_cost_pc.x) %>%
left_join(county.regions, by = "region")
# x is 2015, y is 2017
comp <- county_2015 %>%
left_join(county_2017, by = "region") %>%
mutate(death_cost_diff = (death_cost.y - death_cost.x) / death_cost.x) %>%
mutate(death_cost_pc_diff = (death_cost_pc.y - death_cost_pc.x) / death_cost_pc.x) %>%
mutate(death_cost_diff = (total_cost.y - total_cost.x) / total_cost.x) %>%
mutate(death_cost_pc_diff = (per_capita_total_cost.y - per_capita_total_cost.x) / per_capita_total_cost.x) %>%
left_join(county.regions, by = "region")
# x is 2015, y is 2017
comp <- county_2015 %>%
left_join(county_2017, by = "region") %>%
mutate(death_cost_diff = (death_cost.y - death_cost.x) / death_cost.x) %>%
mutate(death_cost_pc_diff = (death_cost_pc.y - death_cost_pc.x) / death_cost_pc.x) %>%
mutate(total_cost_diff = (total_cost.y - total_cost.x) / total_cost.x) %>%
mutate(total_cost_pc_diff = (per_capita_total_cost.y - per_capita_total_cost.x) / per_capita_total_cost.x) %>%
left_join(county.regions, by = "region")
hist(comp$total_cost_diff)
# x is 2015, y is 2017
comp <- county_2015 %>%
left_join(county_2017, by = "region") %>%
mutate(death_cost_diff = (death_cost.y - death_cost.x) / death_cost.x) %>%
mutate(death_cost_pc_diff = (death_cost_pc.y - death_cost_pc.x) / death_cost_pc.x) %>%
mutate(total_cost_diff = (total_cost.y - total_cost.x) / total_cost.x) %>%
mutate(total_cost_pc_diff = (per_capita_total_cost.y - per_capita_total_cost.x) / per_capita_total_cost.x) %>%
mutate(death_cost_diff_abs = (death_cost.y - death_cost.x) ) %>%
mutate(death_cost_pc_diff_abs = (death_cost_pc.y - death_cost_pc.x) ) %>%
mutate(total_cost_diff_abs = (total_cost.y - total_cost.x) ) %>%
mutate(total_cost_pc_diff_abs = (per_capita_total_cost.y - per_capita_total_cost.x) ) %>%
left_join(county.regions, by = "region")
# x is 2015, y is 2017
comp <- county_2015 %>%
left_join(county_2017, by = "region") %>%
left_join(county.regions, by = "region") %>%
mutate(death_cost_diff = (death_cost.y - death_cost.x) / death_cost.x) %>%
mutate(death_cost_pc_diff = (death_cost_pc.y - death_cost_pc.x) / death_cost_pc.x) %>%
mutate(total_cost_diff = (total_cost.y - total_cost.x) / total_cost.x) %>%
mutate(total_cost_pc_diff = (per_capita_total_cost.y - per_capita_total_cost.x) / per_capita_total_cost.x) %>%
mutate(death_cost_diff_abs = (death_cost.y - death_cost.x) ) %>%
mutate(death_cost_pc_diff_abs = (death_cost_pc.y - death_cost_pc.x) ) %>%
mutate(total_cost_diff_abs = (total_cost.y - total_cost.x) ) %>%
mutate(total_cost_pc_diff_abs = (per_capita_total_cost.y - per_capita_total_cost.x) )
View(drug_deaths)
View(death_reg_table_cy)
View(demographics)
View(criminal_costs)
View(d1_deaths)
View(d2_deaths)
# x is 2015, y is 2017
comp <- county_2015 %>%
left_join(county_2017, by = "region") %>%
left_join(county.regions, by = "region") %>%
mutate(death_cost_diff = (death_cost.y - death_cost.x)  * 100 / death_cost.x) %>%
mutate(death_cost_pc_diff = (death_cost_pc.y - death_cost_pc.x)* 100 / death_cost_pc.x) %>%
mutate(total_cost_diff = (total_cost.y - total_cost.x)* 100 / total_cost.x) %>%
mutate(total_cost_pc_diff = (per_capita_total_cost.y - per_capita_total_cost.x)* 100 / per_capita_total_cost.x) %>%
mutate(death_cost_diff_abs = (death_cost.y - death_cost.x) ) %>%
mutate(death_cost_pc_diff_abs = (death_cost_pc.y - death_cost_pc.x) ) %>%
mutate(total_cost_diff_abs = (total_cost.y - total_cost.x) ) %>%
mutate(total_cost_pc_diff_abs = (per_capita_total_cost.y - per_capita_total_cost.x) )
hist(comp$total_cost_diff)
# x is 2015, y is 2017
comp <- county_2015 %>%
left_join(county_2017, by = "region") %>%
left_join(county.regions, by = "region") %>%
mutate(death_cost_diff_pct = (death_cost.y - death_cost.x)  * 100 / death_cost.x) %>%
mutate(death_cost_pc_diff_pct = (death_cost_pc.y - death_cost_pc.x)* 100 / death_cost_pc.x) %>%
mutate(total_cost_diff_pct = (total_cost.y - total_cost.x)* 100 / total_cost.x) %>%
mutate(total_cost_pc_diff_pct = (per_capita_total_cost.y - per_capita_total_cost.x)* 100 / per_capita_total_cost.x) %>%
mutate(death_cost_diff_abs = (death_cost.y - death_cost.x) ) %>%
mutate(death_cost_pc_diff_abs = (death_cost_pc.y - death_cost_pc.x) ) %>%
mutate(total_cost_diff_abs = (total_cost.y - total_cost.x) ) %>%
mutate(total_cost_pc_diff_abs = (per_capita_total_cost.y - per_capita_total_cost.x) )
hist(comp$total_cost_diff_pct)
summary(comp$total_cost_diff_pct)
# opioid cost parameters, from the updated CEA estimates
fatal_costs <- 699.492144
nonfatal_health_costs <- total_nonfatal_costs * 0.5068966
total_criminal_justice_costs <- total_nonfatal_costs * 0.1344828
total_productivity_costs <- total_nonfatal_costs * 0.3586207
d <- county.regions %>% tbl_df %>%
left_join(proj_opioid_deaths %>% select(region, est_opioid_deaths)) %>%
left_join(proj_hospital_costs %>% select(region, est_total_hosp_costs)) %>%
left_join(nonmedical_use) %>%
left_join(medical_cost_index) %>%
left_join(criminal_costs) %>%
left_join(demographics)
### MAKE MAPS FOR COUNTIES
======
```{r, make.county.maps}
# here we map opioid costs by county
# we exclude Alaska and Hawaii
o <- d %>%
filter(total_population > 2500, !(state.name %in% c("alaska", "hawaii"))) %>%
select(region, county.name, state.name, death_cost, death_cost_pc,
health_cost, health_cost_pc, criminal_cost, criminal_cost_pc,
productivity_cost, productivity_cost_pc, total_population) %>%
mutate(nonfatal_cost = (criminal_cost + health_cost + productivity_cost),
total_cost = (criminal_cost + health_cost + productivity_cost + death_cost),
per_capita_nf_cost = (criminal_cost + health_cost + productivity_cost)/total_population,
per_capita_total_cost = (criminal_cost + health_cost + productivity_cost + death_cost)/total_population)
write_csv(o, "../out/county_data_2017.csv")
map1 <- o %>% select(region, per_capita_nf_cost) %>%
mutate(value = per_capita_nf_cost) %>%
select(region, value)
q <- c(56, 129, 153, 183, 231, 727)
# create county map
c = CountyChoropleth$new(map1)
# create county map
c = CountyChoropleth$new(map1)
c$title = "Non-Fatal Opioid Costs Per Capita by County in 2015"
c$set_num_colors(5)
c$set_zoom(state.regions$region[-c(1, 12)])
c$set_zoom(state.regions$region[-c(1, 12)])
c$ggplot_scale = scale_fill_manual(values = brewer.pal(5, "Oranges"),
name = "Per Capita Cost",
labels = c(str_c("$", q[1] %>% round, " to $", q[2] %>% round),
str_c("$", q[2] %>% round, " to $", q[3] %>% round),
str_c("$", q[3] %>% round, " to $", q[4] %>% round),
str_c("$", q[4] %>% round, " to $", q[5] %>% round),
str_c("$", q[5] %>% round, " to $", q[6] %>% round)),
na.value = "black",
drop = F)
c$render() +
theme(text=element_text(size=14,  family="Times")) +
theme(plot.title = element_text(hjust = 0.5),
plot.caption = element_text(size = 8),
legend.title = element_text(size = 12),
legend.text = element_text(size = 10))
c$set_num_colors(5)
c$set_zoom(state.regions$region[-c(1, 12)])
c$ggplot_scale = scale_fill_manual(values = brewer.pal(5, "Oranges"),
name = "Per Capita Cost",
labels = c(str_c("$", q[1] %>% round, " to $", q[2] %>% round),
str_c("$", q[2] %>% round, " to $", q[3] %>% round),
str_c("$", q[3] %>% round, " to $", q[4] %>% round),
str_c("$", q[4] %>% round, " to $", q[5] %>% round),
str_c("$", q[5] %>% round, " to $", q[6] %>% round)),
na.value = "black",
drop = F)
c$render() +
theme(text=element_text(size=14,  family="Times")) +
theme(plot.title = element_text(hjust = 0.5),
plot.caption = element_text(size = 8),
legend.title = element_text(size = 12),
legend.text = element_text(size = 10))
### MAKE MAPS FOR STATES
map2 <- o %>% select(region, per_capita_total_cost) %>%
mutate(value = per_capita_total_cost) %>%
select(region, value)
c$render() +
theme(text=element_text(size=14,  family="Times")) +
theme(plot.title = element_text(hjust = 0.5),
plot.caption = element_text(size = 8),
legend.title = element_text(size = 12),
legend.text = element_text(size = 10))
map2 <- o %>% select(region, per_capita_total_cost) %>%
mutate(value = per_capita_total_cost) %>%
select(region, value)
q <- c(160, 824, 1153, 1585, 2232, 8734)
c = CountyChoropleth$new(map2)
c$title = "Total Opioid Costs Per Capita by County in 2015"
c$set_num_colors(5)
c$set_zoom(state.regions$region[-c(1, 12)])
c$ggplot_scale = scale_fill_manual(values = brewer.pal(5, "Oranges"),
name = "Per Capita Cost",
na.value = "black",
labels = c(str_c("$", q[1] %>% round, " to $", q[2] %>% round),
str_c("$", q[2] %>% round, " to $", q[3] %>% round),
str_c("$", q[3] %>% round, " to $", q[4] %>% round),
str_c("$", q[4] %>% round, " to $", q[5] %>% round),
str_c("$", q[5] %>% round, " to $", q[6] %>% round)),
drop = F)
c$render() +
theme(text=element_text(size=14,  family="Times")) +
theme(plot.title = element_text(hjust = 0.5),
plot.caption = element_text(size = 8),
legend.title = element_text(size = 12),
legend.text = element_text(size = 10))
```{r, make.state.maps}
county_2015 <- read_csv("../out/county_data_2015.csv")
state_2015 <- read_csv("../out/state_data_2015.csv")
county_2017 <- read_csv("../out/county_data_2017.csv")
state_2017 <- read_csv("../out/state_data_2015.csv")
data(county.regions)
# x is 2015, y is 2017
comp <- county_2015 %>%
left_join(county_2017, by = "region") %>%
left_join(county.regions, by = "region") %>%
mutate(death_cost_diff_pct = (death_cost.y - death_cost.x)  * 100 / death_cost.x) %>%
mutate(death_cost_pc_diff_pct = (death_cost_pc.y - death_cost_pc.x)* 100 / death_cost_pc.x) %>%
mutate(total_cost_diff_pct = (total_cost.y - total_cost.x)* 100 / total_cost.x) %>%
mutate(total_cost_pc_diff_pct = (per_capita_total_cost.y - per_capita_total_cost.x)* 100 / per_capita_total_cost.x) %>%
mutate(death_cost_diff_abs = (death_cost.y - death_cost.x) ) %>%
mutate(death_cost_pc_diff_abs = (death_cost_pc.y - death_cost_pc.x) ) %>%
mutate(total_cost_diff_abs = (total_cost.y - total_cost.x) ) %>%
mutate(total_cost_pc_diff_abs = (per_capita_total_cost.y - per_capita_total_cost.x) )
hist(comp$total_cost_diff_pct)
summary(comp$total_cost_diff_pct)
hist(comp$total_cost_pc_diff_pct)
summary(comp$total_cost_pc_diff_pct)
